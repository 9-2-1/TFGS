<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<input style="width:100%;font-size:20px;" type="text" id="inn" />
<textarea style="width:100%;height:90%;font-size:20px;" type="text" id="out"></textarea>
<script>
	function WorkerFunc(func,callback){
		let blob = new Blob(["(" + func.toString() + ")()"], {type:"text/javascript"});
		let reader = new FileReader();
		reader.addEventListener('loadend', function(event){
			// alert(event.target.result);
			worker = new Worker(event.target.result)
			callback(worker);
		});
		reader.readAsDataURL(blob);
	}

	var inn = document.getElementById("inn");
	var out = document.getElementById("out");
	var wok;
	WorkerFunc(workerF,function(wo){
		wok = wo;
		wok.onmessage = function(msg){
			workTime = false;
			out.style.color = "black";
			out.value = msg.data;
		}
		wok.onerror = function(err){
			workTime = false;
			out.style.color = "red";
			out.value = err.message;
			err.preventDefault();
		}
	});
	var workTime = false, workTout = -1;
	inn.addEventListener('keydown',innChange);
	inn.addEventListener('paste',innChange);
	function innChange(event){
		setTimeout(function(){
			if(workTime){
				if(workTout === null){
					workTout = setInterval(function(){
						if(!workTime){
							startWork();
							clearInterval(workTout);
							workTout = null;
						}
					},30);
				}
			}else{
				startWork();
			}
		},0);
	}
	function startWork(){
		out.style.color = "blue";
		workTime = true;
		wok.postMessage(inn.value);
	}

	out.addEventListener('focus',function(event){
		out.blur();
	});

	function workerF() {
	// start worker
	
	onmessage = function(msg){
		postMessage(match(msg.data));
	}

	var pattern = [
		// .x. 类优先级：优先级从小到大，相同只可右包含
		"if . then .",
		"if . then . else .",
		". and .",
		". or .",
		"not .",
		"(.)",
		".+.",
		".-.",
		".*.",
		"./.",
		".?.:.",
	];

	function match(text){
		var tree = [];
		var fillings, fillParent;
		var diffCache;
		var resultIn;
		var results;
		var errorLevel = -1/2;
		var specPattern;
		getSpecialPattern();
		do {
			errorLevel += 1;
			fillings = [];
			fillParent = [];
			diffCache = {};
			resultIn = {};
			results = [];
			search(tree,null);
		} while(results.length < 2 && errorLevel < text.length * 0.2);
		return errorLevel + "\n" + results.sort(sortResult).join('\n');
		function getSpecialPattern(){
			specPattern = [];
			for(var i=0;i<pattern.length;i++){
				specPattern.push(
					pattern[i].substr(0,1) === "." &&
					pattern[i].substr(-1) === "."
				);
			}
		}
		function sortResult(a,b){
			return Number(a.split('\t')[0]) - Number(b.split('\t')[0]);
		}
		function search(thisTree,parent){
			var str = tree2str(tree);
			var diff = diffText(str);
			for(var i=0;i<pattern.length;i++){
				if(parent !== null && specPattern[parent.id]){
					if(specPattern[i]){
						if(parent.id > i){
							continue;
						}
						if(parent.id == i && parent.pos == 1){
							continue;
						}
					}
				}
				var diff1 = tryPattern(thisTree,i);
				if(diff1 < diff){
					checkFillings(thisTree);
					//diff0 = diff1;
				}
			}
			thisTree.splice(0,thisTree.length);
			checkFillings([]);
			return diff;
		}
		function tryPattern(thisTree,id){
			thisTree.splice(0,thisTree.length);
			thisTree.push(id);
			var patte = pattern[id];
			var re = /\./g;
			var resu;
			while((resu = re.exec(patte)) !== null){
				thisTree.push([]);
			}
			str = tree2str(tree);
			return diffText(str);
		}
		function checkFillings(thisTree){
			for(var i=1;i<thisTree.length;i++){
				fillings.push(thisTree[i]);
				fillParent.push({
					id: thisTree[0],
					pos: i
				});
			}
			if(fillings.length !== 0){
				var fill=fillings.pop();
				var pare=fillParent.pop();
				search(fill,pare);
				fillings.push(fill);
				fillParent.push(pare);
			}else{
				var str = tree2str(tree);
				if(!(str in resultIn)){
					results.push(diffText(str,text) + "\t" + tree2debugstr(tree));
					resultIn[str]=1;
				}
			}
			for(var i=1;i<thisTree.length;i++){
				fillings.pop();
				fillParent.pop();
			}
		}
		function tree2str(tree){
			if(tree.length == 0){
				return ".";
			}else{
				var cnt=0;
				return pattern[tree[0]].replace(/\./g,function(){
					cnt++;
					return tree2str(tree[cnt]);
				})
			}
		}
		function tree2debugstr(tree){
			if(tree.length == 0){
				return ".";
			}else{
				var cnt=0;
				return '[' + pattern[tree[0]].replace(/\./g,function(){
					cnt++;
					return tree2debugstr(tree[cnt]);
				}) + ']';
			}
		}
		function diffText(str){
			if(str in diffCache){
				return diffCache[str];
			}
			str = str.replace(/\./g,"");
			var dp = [], leftup, min, min2;
			for(var x=0;x<=str.length;x++){
				dp.push(x * text.length);
			}
			for(var y=0;y<text.length;y++){
				leftup = dp[0];
				dp[0] = (y+1) * errorLevel;
				for(var x=0;x<str.length;x++){
					min = Math.min(
						dp[ x ] + text.length,
						dp[x+1] + errorLevel,
						leftup + (str[x]===text[y] ? 0 :
						errorLevel + text.length)
					);
					leftup = dp[x+1];
					dp[x+1] = min;
				}
			}
			return dp[str.length];
		}
	}
	// end worker
	}
</script>
